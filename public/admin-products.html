<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin - Manage Products</title>
<style>
  body { background: #121212; color: white; font-family: Arial, sans-serif; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { padding: 10px; border: 1px solid #333; text-align: left; }
  input, button { padding: 6px; margin: 4px 0; width: 100%; box-sizing: border-box; }
  button { cursor: pointer; }
  .product-row:hover { background: #222; }
  .form-section { background: #222; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
</style>
</head>
<body>

<h1>Manage Products</h1>

<!-- Add new product -->
<div class="form-section">
  <h2>Add New Product</h2>
  <form id="addProductForm">
    <input type="text" id="addName" placeholder="Product Name" required />
    <input type="text" id="addDescription" placeholder="Description" />
    <input type="number" step="0.01" id="addPrice" placeholder="Price" required />
    <input type="text" id="addImage" placeholder="Image URL" />
    <input type="email" id="addEmail1" placeholder="Email 1" />
    <input type="text" id="addPassword1" placeholder="Password 1" />
    <input type="email" id="addEmail2" placeholder="Email 2" />
    <input type="text" id="addPassword2" placeholder="Password 2" />
    <button type="submit">Add Product</button>
  </form>
</div>

<!-- Product list -->
<table id="productsTable">
  <thead>
    <tr>
      <th>Name</th><th>Description</th><th>Price</th><th>Image URL</th>
      <th>Email 1</th><th>Password 1</th><th>Email 2</th><th>Password 2</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows get inserted here -->
  </tbody>
</table>

<script>
  const productsTableBody = document.querySelector('#productsTable tbody');
  const addForm = document.getElementById('addProductForm');

  // Load products from backend
  async function loadProducts() {
    const res = await fetch('/products');
    const products = await res.json();
    productsTableBody.innerHTML = '';

    products.forEach(prod => {
      const tr = document.createElement('tr');
      tr.classList.add('product-row');

      tr.innerHTML = `
        <td><input type="text" value="${prod.name || ''}" data-id="${prod.id}" data-field="name" /></td>
        <td><input type="text" value="${prod.description || ''}" data-id="${prod.id}" data-field="description" /></td>
        <td><input type="number" step="0.01" value="${prod.price || ''}" data-id="${prod.id}" data-field="price" /></td>
        <td><input type="text" value="${prod.image || ''}" data-id="${prod.id}" data-field="image" /></td>
        <td><input type="email" value="${prod.email1 || ''}" data-id="${prod.id}" data-cred="email1" /></td>
        <td><input type="text" value="${prod.password1 || ''}" data-id="${prod.id}" data-cred="password1" /></td>
        <td><input type="email" value="${prod.email2 || ''}" data-id="${prod.id}" data-cred="email2" /></td>
        <td><input type="text" value="${prod.password2 || ''}" data-id="${prod.id}" data-cred="password2" /></td>
        <td>
          <button data-id="${prod.id}" class="updateProductBtn">Update Info</button>
          <button data-id="${prod.id}" class="updateCredsBtn">Update Credentials</button>
          <button data-id="${prod.id}" class="deleteProductBtn">Delete</button>
        </td>
      `;

      productsTableBody.appendChild(tr);
    });

    // Add event listeners after rows created
    document.querySelectorAll('.updateProductBtn').forEach(btn => {
      btn.addEventListener('click', updateProductHandler);
    });
    document.querySelectorAll('.updateCredsBtn').forEach(btn => {
      btn.addEventListener('click', updateCredentialsHandler);
    });
    document.querySelectorAll('.deleteProductBtn').forEach(btn => {
      btn.addEventListener('click', deleteProductHandler);
    });
  }

  async function updateProductHandler(event) {
    const id = event.target.dataset.id;
    // Find inputs for name, description, price, image in same row
    const row = event.target.closest('tr');
    const name = row.querySelector('input[data-field="name"]').value.trim();
    const description = row.querySelector('input[data-field="description"]').value.trim();
    const price = row.querySelector('input[data-field="price"]').value.trim();
    const image = row.querySelector('input[data-field="image"]').value.trim();

    if (!name || !price) {
      alert('Name and price are required');
      return;
    }

    const response = await fetch(`/update-product/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description, price, image })
    });

    if (response.ok) {
      alert('Product info updated!');
      loadProducts();
    } else {
      alert('Failed to update product');
    }
  }

  async function updateCredentialsHandler(event) {
    const id = event.target.dataset.id;
    const row = event.target.closest('tr');
    const email1 = row.querySelector('input[data-cred="email1"]').value.trim();
    const password1 = row.querySelector('input[data-cred="password1"]').value.trim();
    const email2 = row.querySelector('input[data-cred="email2"]').value.trim();
    const password2 = row.querySelector('input[data-cred="password2"]').value.trim();

    const response = await fetch(`/update-credentials/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email1, password1, email2, password2 })
    });

    if (response.ok) {
      alert('Credentials updated!');
      loadProducts();
    } else {
      alert('Failed to update credentials');
    }
  }

  async function deleteProductHandler(event) {
    if (!confirm('Delete this product?')) return;
    const id = event.target.dataset.id;

    const response = await fetch(`/delete-product/${id}`, { method: 'DELETE' });
    if (response.ok) {
      alert('Product deleted!');
      loadProducts();
    } else {
      alert('Failed to delete product');
    }
  }

  addForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('addName').value.trim();
    const description = document.getElementById('addDescription').value.trim();
    const price = document.getElementById('addPrice').value.trim();
    const image = document.getElementById('addImage').value.trim();
    const email1 = document.getElementById('addEmail1').value.trim();
    const password1 = document.getElementById('addPassword1').value.trim();
    const email2 = document.getElementById('addEmail2').value.trim();
    const password2 = document.getElementById('addPassword2').value.trim();

    if (!name || !price) {
      alert('Name and price are required');
      return;
    }

    const response = await fetch('/add-product', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description, price, image, email1, password1, email2, password2 })
    });

    if (response.ok) {
      alert('Product added!');
      addForm.reset();
      loadProducts();
    } else {
      alert('Failed to add product');
    }
  });

  // Load products on page load
  loadProducts();
</script>

</body>
</html>
