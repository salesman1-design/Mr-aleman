<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Sales Platform</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f8f9fa;
    }
    h1 {
      text-align: center;
    }
    #searchBar {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #productList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
    }
    .product-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .product-card img {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .product-info {
      flex-grow: 1;
    }
    .product-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
    }
    .product-price {
      color: #28a745;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .product-description {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
    form {
      margin-top: 30px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
    }
    form h2 {
      margin-bottom: 15px;
      text-align: center;
    }
    form input, form select, form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    form button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    form button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<h1>Car Sales Platform</h1>

<input type="text" id="searchBar" placeholder="Search products by name..." />

<div id="productList"></div>

<form id="orderForm">
  <h2>Place an Order</h2>
  <select id="productSelect" required>
    <option value="">Select a product</option>
  </select>
  <input type="email" id="customerEmail" placeholder="Your Email" required />
  <button type="submit">Place Order</button>
</form>

<script>
  let products = [];

  async function fetchProducts() {
    const res = await fetch('/api/products');
    if (!res.ok) {
      alert('Failed to load products.');
      return;
    }
    products = await res.json();
    renderProducts(products);
    populateProductSelect(products);
  }

  function renderProducts(productsToRender) {
    const container = document.getElementById('productList');
    container.innerHTML = '';
    if (productsToRender.length === 0) {
      container.innerHTML = '<p>No products found.</p>';
      return;
    }
    productsToRender.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.image_url || 'https://via.placeholder.com/150'}" alt="${p.name}" />
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-price">$${Number(p.price).toFixed(2)}</div>
          <div class="product-description">${p.description || ''}</div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function populateProductSelect(products) {
    const select = document.getElementById('productSelect');
    select.innerHTML = '<option value="">Select a product</option>';
    products.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.name;
      select.appendChild(option);
    });
  }

  document.getElementById('searchBar').addEventListener('input', e => {
    const query = e.target.value.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(query));
    renderProducts(filtered);
    populateProductSelect(filtered);
  });

  document.getElementById('orderForm').addEventListener('submit', async e => {
    e.preventDefault();
    const productId = document.getElementById('productSelect').value;
    const email = document.getElementById('customerEmail').value.trim();

    if (!productId || !email) {
      alert('Please select a product and enter your email.');
      return;
    }

    const res = await fetch('/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ product_id: productId, customer_email: email })
    });

    if (res.ok) {
      alert('Order placed successfully. Please check your email for details.');
      e.target.reset();
    } else {
      const err = await res.json();
      alert(err.error || 'Failed to place order.');
    }
  });

  fetchProducts();
</script>

</body>
</html>
