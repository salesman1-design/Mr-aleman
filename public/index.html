<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Sales Platform</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f8f9fa;
      margin: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    h1 {
      margin: 0;
      font-size: 2rem;
      color: #333;
    }
    #logo {
      max-width: 160px;
      cursor: pointer;
      user-select: none;
    }
    #searchBar {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 25px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    #searchBar:focus {
      outline: none;
      border-color: #007bff;
    }
    #productList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    .product-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.08);
      padding: 15px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s ease;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgb(0 0 0 / 0.12);
    }
    .product-card img {
      width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f0f0f0;
    }
    .product-info {
      flex-grow: 1;
      margin-bottom: 12px;
    }
    .product-name {
      font-weight: 600;
      font-size: 18px;
      color: #222;
      margin-bottom: 6px;
    }
    .product-price {
      color: #28a745;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .product-description {
      font-size: 14px;
      color: #555;
      line-height: 1.3;
      min-height: 38px; /* Keep consistent height */
    }
    .buy-button {
      padding: 10px 0;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    .buy-button:hover {
      background-color: #0056b3;
    }
    form {
      max-width: 420px;
      margin: 0 auto 50px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgb(0 0 0 / 0.1);
      font-size: 16px;
    }
    form h2 {
      margin-bottom: 20px;
      text-align: center;
      color: #333;
      font-weight: 600;
    }
    form input, form select, form button {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border-radius: 7px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    form input:focus, form select:focus {
      outline: none;
      border-color: #007bff;
    }
    form button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 18px;
      transition: background-color 0.3s ease;
    }
    form button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<header>
  <h1>Car Sales Platform</h1>
  <img
    id="logo"
    src="https://via.placeholder.com/160x50?text=Logo"
    alt="Car Sales Logo"
    title="Double-click to login as Admin"
  />
</header>

<input type="text" id="searchBar" placeholder="Search products by name..." />

<div id="productList"></div>

<form id="orderForm">
  <h2>Place an Order</h2>
  <select id="productSelect" required>
    <option value="">Select a product</option>
  </select>
  <input type="email" id="customerEmail" placeholder="Your Email" required />
  <button type="submit">Place Order</button>
</form>

<script>
  let products = [];

  // Redirect admin login on double click of logo
  document.getElementById('logo').addEventListener('dblclick', () => {
    window.location.href = '/admin/login';
  });

  async function fetchProducts() {
    try {
      const res = await fetch('/api/products');
      if (!res.ok) throw new Error('Failed to load products.');
      products = await res.json();
      renderProducts(products);
      populateProductSelect(products);
    } catch (error) {
      alert(error.message);
    }
  }

  function renderProducts(productsToRender) {
    const container = document.getElementById('productList');
    container.innerHTML = '';
    if (productsToRender.length === 0) {
      container.innerHTML = '<p>No products found.</p>';
      return;
    }
    productsToRender.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.image_url || 'https://via.placeholder.com/280x160?text=No+Image'}" alt="${p.name}" />
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-price">$${Number(p.price).toFixed(2)}</div>
          <div class="product-description">${p.description || ''}</div>
        </div>
        <button class="buy-button" data-id="${p.id}">Buy</button>
      `;
      container.appendChild(card);
    });

    // Attach buy button listeners
    container.querySelectorAll('.buy-button').forEach(button => {
      button.addEventListener('click', () => {
        const productId = button.getAttribute('data-id');
        const select = document.getElementById('productSelect');
        select.value = productId;
        document.getElementById('orderForm').scrollIntoView({ behavior: 'smooth' });
      });
    });
  }

  function populateProductSelect(products) {
    const select = document.getElementById('productSelect');
    select.innerHTML = '<option value="">Select a product</option>';
    products.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.name;
      select.appendChild(option);
    });
  }

  document.getElementById('searchBar').addEventListener('input', e => {
    const query = e.target.value.toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(query));
    renderProducts(filtered);
    populateProductSelect(filtered);
  });

  document.getElementById('orderForm').addEventListener('submit', async e => {
    e.preventDefault();
    const productId = document.getElementById('productSelect').value;
    const email = document.getElementById('customerEmail').value.trim();

    if (!productId || !email) {
      alert('Please select a product and enter your email.');
      return;
    }

    try {
      const res = await fetch('/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, customer_email: email })
      });

      if (res.ok) {
        alert('Order placed successfully. Please check your email for details.');
        e.target.reset();
      } else {
        const err = await res.json();
        alert(err.error || 'Failed to place order.');
      }
    } catch (error) {
      alert('Failed to place order. Please try again later.');
    }
  });

  fetchProducts();
</script>

</body>
</html>
